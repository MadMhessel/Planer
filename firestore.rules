rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Collection Group Query для members
    // ============================================
    // Для collection group queries нужно определить правило отдельно
    // Это позволяет выполнять запросы по всем members во всех workspace
    // ВАЖНО: Это правило применяется ТОЛЬКО к collection group queries
    // Обычные запросы к /workspaces/{workspaceId}/members используют правила ниже
    match /{path=**}/members/{memberId} {
      // List: разрешаем для collection group queries
      // Это безопасно, так как запрос уже фильтрует по userId == request.auth.uid
      // и status == 'ACTIVE', поэтому пользователь видит только свои member документы
      allow list: if request.auth != null;
      
      // Get: разрешаем чтение своего member документа
      allow get: if request.auth != null && 
                   (isSuperAdmin() || 
                    // Пользователь может читать свой member документ
                    resource.data.userId == request.auth.uid);
    }
    
    // Вспомогательные функции
    function isMember(workspaceId) {
      // Проверяем, что workspaceId не null и пользователь является членом
      return workspaceId != null && 
             exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid));
    }

    function isSuperAdmin() {
      // Список супер-админов (должен совпадать с SUPER_ADMINS в коде)
      // Проверяем несколькими способами:
      // 1. Через токен (если email есть в токене)
      // 2. Через документ пользователя (более надежно)
      return request.auth != null && (
        // Способ 1: Проверка через токен
        (request.auth.token.email != null &&
         (request.auth.token.email.toLowerCase() == 'crazymhessel@gmail.com' ||
          request.auth.token.email.toLowerCase() == 'terehin.alv@yandex.ru')) ||
        // Способ 2: Проверка через документ пользователя (если есть поле isSuperAdmin)
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true) ||
        // Способ 3: Проверка через email в документе пользователя
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email != null &&
         (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email.toLowerCase() == 'crazymhessel@gmail.com' ||
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email.toLowerCase() == 'terehin.alv@yandex.ru'))
      );
    }

    function isAdminOrOwner(workspaceId) {
      // Супер-админы имеют все права
      return isSuperAdmin() || 
             (exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) &&
              (get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)).data.role == 'ADMIN' ||
               get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)).data.role == 'OWNER'));
    }

    function isActiveMember(workspaceId) {
      return exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)).data.status == 'ACTIVE';
    }

    // ============================================
    // User Profiles
    // ============================================
    match /users/{userId} {
      // Чтение: любой авторизованный пользователь может читать профили
      allow read: if request.auth != null;
      
      // Создание: пользователь может создать свой профиль при регистрации
      // Поддерживаем как обычных пользователей (с email в токене), так и анонимных (для демо-режима)
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.id == userId &&
                       // Для анонимных пользователей email в токене может быть null, поэтому проверяем только если он есть
                       (request.auth.token.email == null || 
                        request.resource.data.email == request.auth.token.email ||
                        request.resource.data.email == 'demo@example.com');
      
      // Обновление: только сам пользователь может обновлять свой профиль
      allow update: if request.auth != null && 
                       request.auth.uid == userId &&
                       // Запрещаем изменение id
                       resource.data.id == request.resource.data.id &&
                       // Для анонимных пользователей разрешаем обновление email (если он не был установлен)
                       (resource.data.email == request.resource.data.email ||
                        resource.data.email == null ||
                        request.resource.data.email == 'demo@example.com');
      
      // Удаление: только сам пользователь (опционально, если нужно)
      allow delete: if request.auth != null && request.auth.uid == userId;
      
      // Подколлекция уведомлений в users (для обратной совместимости, если используется)
      match /notifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ============================================
    // Workspaces
    // ============================================
    match /workspaces/{workspaceId} {
      // Чтение: владелец, члены, супер-админы или в списке allowedEmails (legacy)
      // ИЛИ любой авторизованный пользователь (для проверки существования при принятии приглашения)
      // Поддерживаем анонимных пользователей (для демо-режима)
      // Примечание: workspace содержит только публичную информацию (название, описание),
      // поэтому разрешаем чтение для авторизованных пользователей
      allow read: if request.auth != null && 
        (
          isSuperAdmin() ||
          resource.data.ownerId == request.auth.uid || 
          (request.auth.token.email != null && 
           resource.data.allowedEmails.hasAny([request.auth.token.email])) ||
          exists(/databases/$(database)/documents/workspaces/$(workspaceId)/members/$(request.auth.uid)) ||
          // Разрешаем чтение для авторизованных пользователей (для принятия приглашения)
          request.auth != null
        );
      
      // Создание: любой авторизованный пользователь может создать workspace (включая анонимных для демо-режима)
      allow create: if request.auth != null &&
                       request.resource.data.ownerId == request.auth.uid;
      
      // Обновление: только владелец, админ или супер-админ
      allow update: if request.auth != null && 
                       (isSuperAdmin() ||
                        resource.data.ownerId == request.auth.uid || 
                        isAdminOrOwner(workspaceId));
      
      // Удаление: только владелец (опционально, если нужно)
      allow delete: if request.auth != null && 
                       resource.data.ownerId == request.auth.uid;

      // ============================================
      // Members Subcollection
      // ============================================
      match /members/{memberId} {
        // List: супер-админы и члены workspace могут видеть список участников
        // Для collection group queries разрешаем, если userId совпадает с текущим пользователем
        // Супер-админы могут видеть всех участников всех workspace
        // Для collection group queries проверяем userId документа
        // Поддерживаем анонимных пользователей (для демо-режима)
        // List: супер-админы и члены workspace могут видеть список участников
        // Для обычных запросов (не collection group): workspaceId доступен
        // Примечание: для collection group queries используется отдельное правило выше
        allow list: if request.auth != null && 
                       (isSuperAdmin() || 
                        // Для обычных запросов (не collection group): workspaceId доступен
                        (workspaceId != null && isMember(workspaceId)));
        
        // Get: члены workspace могут видеть конкретного участника
        // Для collection group queries разрешаем, если userId совпадает с текущим пользователем
        // Супер-админы могут читать всех участников всех workspace
        // Разрешаем чтение своего member даже если он еще не существует (для принятия приглашения)
        allow get: if request.auth != null && 
                      (isSuperAdmin() ||
                       // Пользователь может читать свой member (даже если он еще не существует)
                       (request.auth.uid == memberId) ||
                       // Или если member существует и userId совпадает
                       (resource != null && resource.data.userId == request.auth.uid) || 
                       isMember(workspaceId));
        
        // Создание: только админы/владельцы могут добавлять участников
        // ИЛИ пользователь может создать себя при принятии приглашения
        // ИЛИ пользователь является владельцем workspace (при создании workspace)
        // ИЛИ супер-админ
        allow create: if request.auth != null && 
                         (isSuperAdmin() ||
                          isAdminOrOwner(workspaceId) || 
                          // Пользователь может создать себя при принятии приглашения
                          // Проверяем, что пользователь создает себя с правильными данными
                          (request.auth.uid == memberId && 
                           request.resource.data.userId == request.auth.uid &&
                           request.resource.data.status == 'ACTIVE' &&
                           // Email проверяем только если он есть в токене (для анонимных пользователей может быть null)
                           (request.auth.token.email == null || 
                            request.resource.data.email == request.auth.token.email ||
                            request.resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase())) ||
                          // Разрешаем создание member при создании workspace (в транзакции)
                          // Для транзакций get() может не видеть создаваемый workspace, поэтому используем более гибкую проверку
                          (request.resource.data.role == 'OWNER' &&
                           request.resource.data.userId == request.auth.uid &&
                           request.resource.data.userId == memberId &&
                           // Разрешаем если workspace существует и пользователь владелец
                           ((exists(/databases/$(database)/documents/workspaces/$(workspaceId)) &&
                             get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid) ||
                            // Для анонимных пользователей (демо-режим) разрешаем создание member при создании workspace
                            // В транзакции workspace может еще не существовать, поэтому проверяем только по email
                            (request.auth.token.email == null && 
                             request.resource.data.email == 'demo@example.com'))));
        
        // Обновление: только админы/владельцы могут обновлять участников
        // ИЛИ пользователь может обновить себя при принятии приглашения
        // ИЛИ супер-админ
        allow update: if request.auth != null && 
                         (isSuperAdmin() ||
                          isAdminOrOwner(workspaceId) || 
                          // Пользователь может обновить себя при принятии приглашения
                          // Разрешаем если: пользователь обновляет себя, устанавливает статус ACTIVE
                          (request.auth.uid == memberId && 
                           request.resource.data.userId == request.auth.uid &&
                           request.resource.data.status == 'ACTIVE'));
        
        // Удаление: только админы/владельцы могут удалять участников
        // Супер-админы могут удалять участников даже если не являются членами workspace
        // Проверяем isSuperAdmin() первым, чтобы избежать проблем с isAdminOrOwner для не-членов
        allow delete: if request.auth != null && 
                         (isSuperAdmin() || isAdminOrOwner(workspaceId));
      }

      // ============================================
      // Invites Subcollection
      // ============================================
      match /invites/{token} {
        // List: члены workspace могут видеть список приглашений
        // Это нужно для отображения списка приглашений в настройках
        allow list: if request.auth != null && 
                      (isSuperAdmin() || 
                       isMember(workspaceId));
        
        // Get: любой авторизованный может получить конкретное приглашение по token
        // (для проверки при принятии приглашения)
        allow get: if request.auth != null;
        
        // Создание: только админы/владельцы могут создавать приглашения
        allow create: if request.auth != null && isAdminOrOwner(workspaceId);
        
        // Обновление: админы/владельцы могут обновлять (отзывать)
        // ИЛИ пользователь может обновить статус на ACCEPTED при принятии
        allow update: if request.auth != null && 
                         (isAdminOrOwner(workspaceId) || 
                          (resource.data.status == 'PENDING' &&
                           request.resource.data.status == 'ACCEPTED' &&
                           // Email проверяем только если он есть в токене (для анонимных пользователей может быть null)
                           (request.auth.token.email == null || 
                            resource.data.email == request.auth.token.email ||
                            resource.data.email.toLowerCase() == request.auth.token.email.toLowerCase())));
        
        // Удаление: только админы/владельцы
        allow delete: if request.auth != null && isAdminOrOwner(workspaceId);
      }

      // ============================================
      // Tasks Subcollection (если используется)
      // ============================================
      match /tasks/{taskId} {
        allow read: if request.auth != null && isMember(workspaceId);
        allow create: if request.auth != null && isMember(workspaceId);
        allow update: if request.auth != null && isMember(workspaceId);
        allow delete: if request.auth != null && isMember(workspaceId);
      }
      
      // ============================================
      // Projects Subcollection (если используется)
      // ============================================
      match /projects/{projectId} {
        allow read: if request.auth != null && isMember(workspaceId);
        allow create: if request.auth != null && isMember(workspaceId);
        allow update: if request.auth != null && isMember(workspaceId);
        allow delete: if request.auth != null && isMember(workspaceId);
      }

      // ============================================
      // Notifications Subcollection
      // ============================================
      match /notifications/{notificationId} {
        // List: члены workspace могут видеть список уведомлений
        // Фильтрация по recipients происходит на клиенте
        allow list: if request.auth != null && isMember(workspaceId);
        
        // Get: члены workspace могут читать конкретное уведомление
        allow get: if request.auth != null && isMember(workspaceId);
        
        // Создание: члены workspace могут создавать уведомления
        allow create: if request.auth != null && isMember(workspaceId);
        
        // Обновление: члены workspace могут обновлять уведомления (помечать как прочитанные)
        allow update: if request.auth != null && isMember(workspaceId);
        
        // Удаление: пользователи могут удалять уведомления, которые им видны
        // (нет recipients или пользователь в recipients)
        allow delete: if request.auth != null && isMember(workspaceId) &&
          (!resource.data.keys().hasAny(['recipients']) || 
           resource.data.recipients.size() == 0 || 
           resource.data.recipients.hasAny([request.auth.uid]));
      }
    }
    
    // ============================================
    // Global Tasks Collection
    // ============================================
    match /tasks/{taskId} {
      // List: для запросов разрешаем чтение
      // Это безопасно, так как запрос уже фильтрует по workspaceId,
      // а правило get проверяет членство для каждого документа
      allow list: if request.auth != null;
      
      // Get: члены workspace могут читать задачи своего workspace
      allow get: if request.auth != null && 
                   (isSuperAdmin() ||
                    (resource.data.workspaceId != null &&
                     isMember(resource.data.workspaceId)));
      
      // Создание: члены workspace могут создавать задачи
      allow create: if request.auth != null && 
                       request.resource.data.workspaceId != null &&
                       request.resource.data.title != null &&
                       request.resource.data.status != null &&
                       request.resource.data.priority != null &&
                       isMember(request.resource.data.workspaceId);
      
      // Обновление: члены workspace могут обновлять задачи
      allow update: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       isMember(resource.data.workspaceId) &&
                       // Запрещаем изменение workspaceId
                       resource.data.workspaceId == request.resource.data.workspaceId;
      
      // Удаление: члены workspace могут удалять задачи
      allow delete: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       isMember(resource.data.workspaceId);
    }
    
    // ============================================
    // Global Projects Collection
    // ============================================
    match /projects/{projectId} {
      // List: для запросов разрешаем чтение
      // Это безопасно, так как запрос уже фильтрует по workspaceId,
      // а правило get проверяет членство для каждого документа
      allow list: if request.auth != null;
      
      // Get: члены workspace могут читать проекты своего workspace
      allow get: if request.auth != null && 
                   (isSuperAdmin() ||
                    (resource.data.workspaceId != null &&
                     isMember(resource.data.workspaceId)));
      
      // Создание: члены workspace могут создавать проекты
      allow create: if request.auth != null && 
                       request.resource.data.workspaceId != null &&
                       request.resource.data.ownerId != null &&
                       request.resource.data.name != null &&
                       request.resource.data.ownerId == request.auth.uid &&
                       isMember(request.resource.data.workspaceId);
      
      // Обновление: владелец проекта или админ workspace могут обновлять
      allow update: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       isMember(resource.data.workspaceId) &&
                       // Запрещаем изменение workspaceId и ownerId
                       resource.data.workspaceId == request.resource.data.workspaceId &&
                       resource.data.ownerId == request.resource.data.ownerId &&
                       (resource.data.ownerId == request.auth.uid || 
                        isAdminOrOwner(resource.data.workspaceId));
      
      // Удаление: владелец проекта или админ workspace могут удалять
      allow delete: if request.auth != null && 
                       resource.data.workspaceId != null &&
                       isMember(resource.data.workspaceId) &&
                       (resource.data.ownerId == request.auth.uid || 
                        isAdminOrOwner(resource.data.workspaceId));
    }
    
    // ============================================
    // Global Settings
    // ============================================
    match /settings/global {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // ============================================
    // Collection Group Queries
    // ============================================
    // Правила для collection group queries (например, collectionGroup('members'))
    // Используется в subscribeToWorkspaces для поиска всех workspace, где пользователь является участником
    
    // Collection Group для members
    // Путь: workspaces/{workspaceId}/members/{memberId}
    // Запросы через collectionGroup('members') должны проверять, что пользователь является членом workspace
    // Это обрабатывается через правила для подколлекции members выше
    // Но для collection group queries нужны дополнительные проверки
    
    // Примечание: Firestore Security Rules автоматически применяют правила подколлекций
    // к collection group queries, поэтому правила выше для /workspaces/{workspaceId}/members/{memberId}
    // будут применяться и к collectionGroup('members')
  }
}
